/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      rawsoc.c
 *
 * @version   1.0
 *
 * @date      27-04-2025
 *
 * @brief     Dedicated for opening an raw socket.
 *
 * @author    Fábio D. Pacheco,
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 *
 * @note      Manuals:
 *
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Imported libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>
#include <errno.h> 
#include <sys/socket.h>
#include <netinet/in.h>
#include <netinet/ether.h>
#include <linux/if_packet.h> 
#include <net/if.h>

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Local Macros
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#define error_print( txt, ... ) fprintf( stderr, "Error: " txt ",at line %d in file %s\n Errno: %d, %s\n", ##__VA_ARGS__, __LINE__, __FILE__, errno, strerror(errno) )

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Functions
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int
rawsocket( const char * interface ){
  if( !interface ){
    errno = EINVAL;
    error_print( "interface is `NULL`" );
    return -1;
  }

  struct sockaddr_ll socaddr;

  // ETH_P_ALL: Receives all Ethernet protocols
  int rs = socket( AF_PACKET, SOCK_RAW, htons(ETH_P_ALL) );
  if( 0 > rs ){
    error_print( "socket" );
    return -1;
  }

  // Get the NIC index, ifr.ifr_ifindex will be filled upon success
  int ifindex = (int) if_nametoindex( interface );
  if( !ifindex ){
    error_print( "if_nametoindex" );
    close( rs );
    return -1;
  }

  // Bind the socket to the interface.
  memset( &socaddr, 0, sizeof(socaddr) );
  socaddr.sll_family = AF_PACKET;
  socaddr.sll_protocol = htons(ETH_P_ALL);
  socaddr.sll_ifindex = ifindex;
  if( 0 > bind( rs, (struct sockaddr *) &socaddr, sizeof(socaddr) ) ){
    error_print( "bind" );
    close( rs );
    return -1;
  }

  return rs;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * End file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
