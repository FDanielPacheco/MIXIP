/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      mixip.c
 * 
 * @version   1.0
 *
 * @date      18-05-2025
 *
 * @brief     MIXIP source file.  
 *  
 * @author    Fábio D. Pacheco, 
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 * 
 * @note      Manuals:
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Imported libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <mixip.h>
#include <errno.h>
#include <unistd.h>
#include <fcntl.h>
#include <shmbuf.h>
#include <string.h>

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Data structures
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

typedef enum{
  IS_TRANSMITTER = 0,
  IS_RECEIVER = 1,  
} mixip_return_t;

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Prototypes
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

int8_t check_mixip_pattern( const char * str );

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Functions
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
mixip_halt( flow_t * flow ){
  if( !flow ){
    errno = EINVAL;
    return -1;
  }

  if( flow->network )
    return 0;

  flow->network = 1;
  sem_wait( &flow->rx_done );
  sem_wait( &flow->tx_done );
  return 0;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
mixip_continue( flow_t * flow ){
  if( !flow ){
    errno = EINVAL;
    return -1;
  }

  if( !flow->network )
    return 0;

  flow->network = 0;
  sem_post( &flow->rx_wait );
  sem_post( &flow->tx_wait );
  return 0;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
mixip_translator_connect( const char * driver_name, translator_parameters_t * param ){
  if( !driver_name ){
    errno = EINVAL;
    return -1;
  }
  
  switch( check_mixip_pattern( driver_name ) ){
    default:
    case -1:
      perror("check_mixip_pattern");
      return -1;
    
    case IS_RECEIVER:
      return 1;
    
    case IS_TRANSMITTER:
      break;
  }

  char path[ NAME_MAX ];
  snprintf( path, NAME_MAX, "/%s_tx_param", driver_name );
  param = (translator_parameters_t *) shm_open2( path, sizeof(buffer_t), O_RDWR, 0 );
  if( !param ){
    perror("shm_open2");
    return -1;      
  }

  return 0;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t
mixip_translator_ring_buffer_size( const uint8_t size, translator_parameters_t * param  ){
  if( !param ){
    errno = EINVAL;
    return -1;
  }

  if( !size ){
    errno = ENOTSUP;
    return -1;
  }
  param->size_rb = size;
  return 0;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t
mixip_translator_serial_link_segment_size( const uint8_t size, translator_parameters_t * param  ){
  if( !param ){
    errno = EINVAL;
    return -1;
  }

  //   __ 3 bytes for the COBS encode and 1 byte for the extra overhead byte, 
  //  /   if the user were to select less or equal to 4 bytes of serial link segment, payload would never be sent
  if( 4 < size ){
    errno = ENOTSUP;
    return -1;
  }
  param->size_sls = size;
  return 0;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t
mixip_translator_activate( translator_parameters_t * param ){
  if( !param ){
    errno = EINVAL;
    return -1;
  }
  param->boot = 1;  
  return 0;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
check_mixip_pattern( const char * str ){
  if( !str ){
    errno = EINVAL;
    return -1;
  }

  char * tx = strstr( str, "tx" );
  char * rx = strstr( str, "rx" );

  if( !tx && !rx ){
    // How can the program arrive at this point without adding the driver role, return error
    printf("Neither tx or rx was found on the string (%s)...\n", str);
    errno = EINVAL;
    return -1;
  }

  if( (NULL != tx) && (NULL != rx) ){
    // Hmm so the user wrote that this driver would be the receiver but call it transmitter or vice-versa, report error but suggest better naming
    printf("Not sure if this driver is the receiver or transmitter (%s), do not use:\n"
           "<rx>\n"
           "  <name>drivertx</name>\n" 
           "</rx>\n"
           "The same applies to <tx> tag on the MIXIP-ID.\n", str);
    errno = EINVAL;
    return -1;
  }

  if( NULL != tx )
    return IS_TRANSMITTER;
  return IS_RECEIVER;
}


/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * End file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
